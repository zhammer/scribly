{% set is_users_turn = story.state == "in_progress" and story.current_writers_turn.id == user.id %}
{% import 'head.html' as head %}
<!DOCTYPE html>
<html lang="en">

<head>
  {{ head.head('Scribly - ' + story.title) }}
</head>

<body>
  <div class="page">
    <div class="story">
      <h1 class="title">{{ story.title }}</h1>
      <div class="{% if not is_users_turn -%} grow {%- endif %}">
        {% for turn in story.turns %}
        {% if turn.action in ["write", "write_and_finish"] %}
        <p class="text">{{ turn.text_written }}</p>
        {% endif %}
        {% if turn.action == "write" %}
        <div class="text-divider"></div>
        {% endif %}
        {% endfor %}
      </div>
      {% if is_users_turn %}
      <textarea name="text" id="text" form="turn-form" autofocus="true"
        class="story__writer {% if is_users_turn -%} grow {%- endif %}"></textarea>
      <form id="turn-form" action="/stories/{{ story.id }}/turn" method="post">
        <div class="flex">
          <button type="submit" id="write" name="action" value="write"
            onclick="return confirm('Once you\'ve submitted your turn, your text can\'t be edited. Are you sure you want to continue?');">
            write
          </button>
          <button type="submit" id="write-and-finish" name="action" value="write_and_finish"
            onclick="return confirm('This will finish the story. Are you sure you want to continue?');">
            write and finish
          </button>
          <button type="submit" id="finish" name="action" value="finish"
            onclick="return confirm('This will finish the story and will IGNORE any text you\'ve written for this turn. Are you sure you want to continue?');">
            finish
          </button>
          <button type="submit" id="pass" name="action" value="pass"
            onclick="return confirm('This will pass over your turn and will IGNORE any text you\'ve written for this turn. Are you sure you want to continue?');">
            pass
          </button>
        </div>
      </form>
      {% endif %}
      <div class="story__details">
        <p>cowriters: {{ story.cowriters|map(attribute='username')|join(', ')}}</p>
        <p>
          {% if story.state == "in_progress" -%}
          turn: {{ story.turns | length }} ({{ story.current_writers_turn.username}}'s turn)
          {%- endif %}
          {% if story.state == "done"  -%}
          story is finished, {{ story.turns | length }} turns
          {%- endif %}
        </p>
      </div>
    </div>
  </div>
</body>

</html>
